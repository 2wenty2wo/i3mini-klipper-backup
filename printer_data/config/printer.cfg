# This file contains pin mappings for the Wanhao Duplicator i3 mini.
# (circa 2017) To use this config, the firmware should be compiled
# for the AVR atmega2560.
# Pin numbers and other parameters were extracted from the official
# Marlin source available at: https://github.com/garychen99/i3Mini

# See docs/Config_Reference.md for a description of parameters.

[include mainsail.cfg]
[include KAMP_Settings.cfg]

[stepper_x]
step_pin: PA0
dir_pin: !PA1
enable_pin: !PF3
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PD2
position_endstop: 120
position_max: 120
homing_speed: 30.0

[stepper_y]
step_pin: PA3
dir_pin: PA4
enable_pin: !PA2
microsteps: 16
rotation_distance: 40
endstop_pin: ^!PD3
position_endstop: 0
position_max: 135
homing_speed: 30.0

[stepper_z]
step_pin: PA7
dir_pin: PG2
enable_pin: !PA6
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop   # <â€” MUST be this
position_min: -2
position_max: 100

[extruder]
step_pin: PF1
dir_pin: PF2
enable_pin: !PF0
microsteps: 16
rotation_distance: 6.329
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PG5
sensor_type: NTC 100K MGB18-104F39050L32
sensor_pin: PK5
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114
min_temp: 1
max_temp: 265
max_extrude_cross_section: 5

[fan]
pin: PB6

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB2.0-Serial-if00-port0

[mcu rpi]
serial: /tmp/klipper_host_mcu

[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

[display]
lcd_type: uc1701
cs_pin: PG0
a0_pin: PG1
rst_pin: PA5
click_pin: ^!PE3
encoder_pins: ^PE5, ^PE4
kill_pin: ^!PK2
contrast: 60

[bltouch]
sensor_pin: ^PD7
control_pin: rpi:gpio17
x_offset: 0.0
y_offset: -37.5
#z_offset: 3.850
probe_with_touch_mode: False
pin_up_reports_not_triggered: True
pin_up_touch_mode_reports_triggered: False
pin_move_time: 0.50

# --- Probe-safe mesh limits (PROBE coordinates) ---
[bed_mesh]
speed: 120
horizontal_move_z: 5
mesh_min: 5, 5          # PROBE coords (front/left)
mesh_max: 115, 97.5     # PROBE coords (back/right) -> keeps nozzle â‰¤ Y135
probe_count: 5,5
algorithm: bicubic

[screws_tilt_adjust]
screw1: 15, 15         # front-left, in PROBE coordinates
screw2: 110, 15        # front-right
screw3: 110, 90        # back-right
screw4: 15, 90         # back-left
horizontal_move_z: 10  # always lift before moving
speed: 100
screw_thread: CW-M3    # turn clockwise to raise bed

[gcode_macro LEVEL_BED]
description: ðŸ”§ Probe 4 corners for screw adjust
gcode:
  G28
  SCREWS_TILT_CALCULATE

# --- KAMP toggles that match your current macros ---
[gcode_macro KAMP_ON]
gcode:
  SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=do_purge VALUE=1
  RESPOND PREFIX=KAMP MSG="Line purge ENABLED. (No change to homing/mesh.)"

[gcode_macro KAMP_OFF]
gcode:
  SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=do_purge VALUE=0
  RESPOND PREFIX=KAMP MSG="Line purge DISABLED. (No change to homing/mesh.)"

[firmware_retraction]
retract_length: 1.0
retract_speed: 25
unretract_extra_length: 0
unretract_speed: 25

[adxl345]
cs_pin: rpi:None

[resonance_tester]
accel_chip: adxl345
probe_points:
    100,100,20

[gcode_macro ADXL_SANITY]
description: Check accelerometer is responding and noise is reasonable
gcode:
  RESPOND PREFIX=ADXL MSG="Querying accelerometerâ€¦"
  ACCELEROMETER_QUERY
  MEASURE_AXES_NOISE

[gcode_macro RESO_TUNE]
description: Home, warm nozzle, run SHAPER_CALIBRATE on X/Y, then prompt to SAVE_CONFIG
variable_temp: 200
gcode:
  {% set t = params.TEMP|default(printer["gcode_macro RESO_TUNE"].temp)|int %}
  M117 Resonance tune startingâ€¦
  {% if printer.toolhead.homed_axes != "xyz" %}
    G28
  {% endif %}
  M104 S{t}
  M109 S{t}
  G90
  # Move to center-ish and lift
  {% set x = printer.toolhead.axis_maximum.x / 2 %}
  {% set y = printer.toolhead.axis_maximum.y / 2 %}
  G1 X{ x|round(1) } Y{ y|round(1) } Z20 F6000
  MEASURE_AXES_NOISE
  SHAPER_CALIBRATE
  M117 Review console output; run SAVE_CONFIG if happy

[gcode_macro PARK]
description: Lift and park front-right
gcode:
  {% if printer.toolhead.homed_axes != "xyz" %}
    G28
  {% endif %}
  G90
  G1 Z20 F6000
  G1 X{printer.toolhead.axis_maximum.x - 5} Y{printer.toolhead.axis_maximum.y - 5} F9000

[safe_z_home]
home_xy_position: 60,104.5
z_hop: 5
z_hop_speed: 5

# ===== START / END for i3 Mini + KAMP Line Purge =====

[gcode_macro START_PRINT]
description: Heat nozzle, home, then KAMP line purge (no heated bed)
variable_do_purge: 1
gcode:
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|int %}
  G21
  G90
  M82
  M107

  M104 S{EXTRUDER_TEMP}
  G28
  M109 S{EXTRUDER_TEMP}

  {% if printer["gcode_macro START_PRINT"].do_purge|int == 1 %}
    ; gentle motion so the extruder never clicks during purge
    {% set ov = printer.toolhead.max_velocity %}
    {% set oa = printer.toolhead.max_accel %}
    SET_VELOCITY_LIMIT VELOCITY=60 ACCEL=400

    LINE_PURGE

    ; --- wipe & slow re-prime to avoid dingleberry and dry start ---
    {% set ph = (printer["gcode_macro _KAMP_Settings"].purge_height|default(0.30))|float %}
    G92 E0
    G1 E-0.6 F1800              ; tiny retract to snap the string
    G1 Z{ph + 0.3} F600         ; lift a touch above purge height
    G1 X5 Y5 F6000              ; wipe to front-left corner (inside 120x135 area)
    G1 Z{ph} F600               ; back to purge-layer height
    G1 E1.0 F150                ; slow prime so first move has pressure
    G92 E0

    SET_VELOCITY_LIMIT VELOCITY={ov} ACCEL={oa}
  {% endif %}

  M117 Printingâ€¦

[gcode_macro END_PRINT]
description: Cooldown and park
gcode:
  M107
  M104 S0
  G91
  G1 E-1 F1800
  G1 Z10 F600
  G90
  G1 X115 Y130 F9000
  M84

[exclude_object]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bltouch]
#*# z_offset = 2.210
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.340000, -0.117500, 0.002500, 0.080000, 0.120000
#*# 	  -0.342500, -0.150000, -0.015000, 0.065000, 0.077500
#*# 	  -0.437500, -0.082500, 0.042500, 0.100000, 0.117500
#*# 	  -0.355000, -0.215000, -0.070000, -0.017500, 0.090000
#*# 	  -0.392500, -0.057500, -0.052500, 0.040000, 0.100000
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 5.0
#*# max_x = 115.0
#*# min_y = 5.0
#*# max_y = 97.48
#*#
#*# [input_shaper]
#*# shaper_type_x = mzv
#*# shaper_freq_x = 61.4
#*# shaper_type_y = ei
#*# shaper_freq_y = 98.0
