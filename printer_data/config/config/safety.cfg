# ─────────────────────────────────────────────────────────────────────────────
# safety.cfg — extra safety rails for heaters & inactivity
# Works with your existing includes (verify_heater, idle timeout, bed power cap).
# ─────────────────────────────────────────────────────────────────────────────

# 1) VERIFY HEATER — Shut down if temperatures don't rise as expected.
#    Tune values if you see false trips (e.g., in very cold rooms or drafty spaces).

[verify_heater extruder]
# Max time Klipper allows cumulative "bad heating" before shutdown.
max_error: 120          # seconds (hotends heat fast; keep this tight)
# How long each window is to check for temperature progress.
check_gain_time: 60     # seconds
# Temperature must rise by at least this much every check_gain_time.
heating_gain: 2         # °C per window
# Allowed +/- temperature wiggle before declaring "not progressing".
hysteresis: 5           # °C

[verify_heater heater_bed]
# Beds are slow and massive → longer windows and timeouts.
max_error: 300          # seconds
check_gain_time: 120    # seconds
heating_gain: 1         # °C per window
hysteresis: 2           # °C

# 2) BED POWER CAP — Reduce stress on PSU, wiring, and external MOSFET.
#    This limits PWM duty cycle. If heating becomes too slow, raise toward 1.0.
#    NOTE: You can declare the same section again to set just this key.
[heater_bed]
max_power: 0.85         # 85% duty; safe starting point for a 120 W bed + external MOSFET

# (Optional) If you wish to also cap the hotend, uncomment below.
# [extruder]
# max_power: 1.0         # Hotends benefit from full power; leave at 1.0 unless you must cap it.

# 3) IDLE TIMEOUT — Heaters OFF + safe park after inactivity.
#    Triggers if no G-code is received for the set time (e.g., you walked away).
[idle_timeout]
timeout: 600            # 10 minutes; adjust to taste
gcode:
  # Turn off part cooling fan and heaters.
  M106 S0
  M104 S0
  M140 S0

  # Try to lift and park safely if your macros are present.
  # Your config defines _PARK_TR_SAFE (top-right + bed forward).
  # If you ever remove that macro, comment the next line to avoid an error.
  _PARK_TR_SAFE

  # Disable steppers.
  M84
  M117 Idle timeout: heaters off

# 4) QUICK PANIC BUTTON — A simple command to kill heat & park.
#    Usage: HEATERS_OFF  (from console/Mainsail macros)
[gcode_macro HEATERS_OFF]
description: Immediately turn off all heaters and park safely
gcode:
  M106 S0
  M104 S0
  M140 S0
  {% if printer.toolhead.homed_axes == "xyz" %}
    _PARK_TR_SAFE
  {% else %}
    # If not homed, at least lift Z a touch in relative mode to avoid scraping.
    SAVE_GCODE_STATE NAME=__panic
    G91
    G1 Z2 F1200
    G90
    RESTORE_GCODE_STATE NAME=__panic
  {% endif %}
  M84
  M117 Heaters OFF