# ─────────────────────────────────────────────────────────────────────────────
# PRINT LIFECYCLE: start/end, pause/resume, parking, cancel, KAMP toggles
# START_PRINT calls KAMP's BED_MESH_CALIBRATE and LINE_PURGE when enabled.
# ─────────────────────────────────────────────────────────────────────────────

# Show the splash logo at startup, then return to the normal UI
[delayed_gcode show_boot_logo]
initial_duration: 1.0
gcode:
  SET_DISPLAY_GROUP GROUP=splash   ; show your logo group (from boot_logo.cfg)
  G4 P2000                         ; keep it for ~2 seconds
  SET_DISPLAY_GROUP GROUP=default  ; <-- correct group name (no underscores)

# Simple KAMP toggles for line purge (mesh toggle is separate var below)
[gcode_macro KAMP_ON]
gcode:
  SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=do_purge VALUE=1
  RESPOND PREFIX=KAMP MSG="Line purge ENABLED. (No change to homing/mesh.)"

[gcode_macro KAMP_OFF]
gcode:
  SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=do_purge VALUE=0
  RESPOND PREFIX=KAMP MSG="Line purge DISABLED. (No change to homing/mesh.)"

# Quick manual park button (front-right)
[gcode_macro PARK]
description: Lift and park front-right
gcode:
  {% if printer.toolhead.homed_axes != "xyz" %} G28 {% endif %}
  G90
  G1 Z20 F6000
  G1 X{printer.toolhead.axis_maximum.x - 5} Y{printer.toolhead.axis_maximum.y - 5} F9000

# Reusable safe park helper (back-right)
[gcode_macro _SAFE_PARK]
description: Lift Z and park back-right safely (fits 120x135 bed)
variable_park_z: 10
gcode:
  {% set parkz = params.Z|default(printer["gcode_macro _SAFE_PARK"].park_z)|int %}
  {% set xmax = printer.configfile.config.stepper_x.position_max|default(120)|int %}
  {% set ymax = printer.configfile.config.stepper_y.position_max|default(135)|int %}
  {% set lift = parkz if parkz > 2 else 2 %}
  SAVE_GCODE_STATE NAME=__park
  G91
  G1 Z{lift} F600
  G90
  G1 X{ x_max|default(xmax) - 5 } Y{ y_max|default(ymax) - 5 } F6000
  RESTORE_GCODE_STATE NAME=__park

# Full-clear safe park (top-right + bed forward)
[gcode_macro _PARK_TR_SAFE]
description: Clamp-safe park: Z to (Zmax-0.5), X/Y to (max - margins), bed forward
variable_x_margin: 2.0
variable_y_margin: 2.0
variable_z_margin: 0.5
gcode:
  {% set x_max = (printer.configfile.config.stepper_x.position_max|default(120))|float %}
  {% set y_max = (printer.configfile.config.stepper_y.position_max|default(135))|float %}
  {% set z_max = (printer.configfile.config.stepper_z.position_max|default(100))|float %}
  {% set xm = (params.X_MARGIN|default(printer["gcode_macro _PARK_TR_SAFE"].x_margin))|float %}
  {% set ym = (params.Y_MARGIN|default(printer["gcode_macro _PARK_TR_SAFE"].y_margin))|float %}
  {% set zm = (params.Z_MARGIN|default(printer["gcode_macro _PARK_TR_SAFE"].z_margin))|float %}
  {% set z_now = printer.toolhead.position.z|float %}
  {% set z_target = (z_max - zm) if (z_max - zm) > z_now else (z_now) %}
  G90
  G1 Z{ z_target|round(3) } F18000
  G1 X{ (x_max - xm)|round(3) } F15000
  G1 Y{ (y_max - ym)|round(3) } F15000

# START_PRINT: heat, home, KAMP adaptive mesh, Smart Park, optional Line Purge
[gcode_macro START_PRINT]
description: Heat, home, KAMP adaptive mesh (via BED_MESH_CALIBRATE), Smart Park, then optional Line Purge
# Runtime switches:
#   SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=do_mesh  VALUE=0/1
#   SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=do_purge VALUE=0/1
variable_do_mesh: 1
variable_do_purge: 1
gcode:
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|int %}

  ; Sane states
  G21
  G90
  M82
  M107

  ; Start warming (don’t wait yet)
  M104 S{EXTRUDER_TEMP}

  ; Home (BLTouch + safe_z_home)
  G28

  ; KAMP adaptive mesh (KAMP overrides BED_MESH_CALIBRATE)
  {% if printer["gcode_macro START_PRINT"].do_mesh|int == 1 %}
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE
  {% endif %}

  ; KAMP Smart Park near print area (requires KAMP Smart_Park include)
  SMART_PARK

  ; Finish heat
  M109 S{EXTRUDER_TEMP}

  ; Optional KAMP line purge with tidy exit
  {% if printer["gcode_macro START_PRINT"].do_purge|int == 1 %}
    LINE_PURGE
    {% set ph = (printer["gcode_macro _KAMP_Settings"].purge_height|default(0.30))|float %}
    {% set hop = 1.0 %}
    {% set move_x = 20.0 %}
    {% set move_y = 20.0 %}
    G92 E0
    G1 E-0.6 F1800
    G1 Z{ (ph + hop)|round(3) } F1200
    G1 X{ move_x } Y{ move_y } F6000
    G1 E0.6 F150
    G92 E0
  {% endif %}

  M117 Printing...

# END_PRINT: retract, cool, safe park (top-right + bed forward)
[gcode_macro END_PRINT]
description: Cooldown and park (top-right + bed forward)
gcode:
  M107
  M104 S0
  G91
  G1 E-1 F1800
  G90
  _PARK_TR_SAFE
  M84

# Pause/Resume with safe park and optional keep-hot
[gcode_macro PAUSE]
description: Pause with park and fan/heater handling
rename_existing: BASE_PAUSE
gcode:
  {% set keep_hot = params.KEEP_HOT|default(1)|int %}
  BASE_PAUSE
  _SAFE_PARK Z=10
  M106 S0
  {% if not keep_hot %} M104 S0 {% endif %}

[gcode_macro RESUME]
description: Resume and restore state
rename_existing: BASE_RESUME
gcode:
  BASE_RESUME

# CANCEL_PRINT: flush queue, retract, cool, park, then return to UI
[gcode_macro CANCEL_PRINT]
description: Cancel with queue flush, retract, cool down, and safe park
rename_existing: BASE_CANCEL_PRINT
gcode:
  M400
  SDCARD_RESET_FILE
  CLEAR_PAUSE
  SAVE_GCODE_STATE NAME=__canc
  M83
  G1 E-2 F1800
  RESTORE_GCODE_STATE NAME=__canc
  M106 S0
  M104 S0
  _PARK_TR_SAFE
  BASE_CANCEL_PRINT