# ─────────────────────────────────────────────────────────────────────────────
# PRINT LIFECYCLE: start/end, pause/resume, parking, cancel, KAMP toggles
# START_PRINT calls KAMP's BED_MESH_CALIBRATE and LINE_PURGE when enabled.
# ─────────────────────────────────────────────────────────────────────────────

# Simple KAMP toggles for line purge (mesh toggle is separate var below)
[gcode_macro KAMP_ON]
gcode:
  SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=do_purge VALUE=1
  RESPOND PREFIX=KAMP MSG="Line purge ENABLED. (No change to homing/mesh.)"

[gcode_macro KAMP_OFF]
gcode:
  SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=do_purge VALUE=0
  RESPOND PREFIX=KAMP MSG="Line purge DISABLED. (No change to homing/mesh.)"

# Quick manual park button (front-right)
[gcode_macro PARK]
description: Lift and park front-right
gcode:
  {% if printer.toolhead.homed_axes != "xyz" %} G28 {% endif %}
  G90
  G1 Z20 F6000
  G1 X{printer.toolhead.axis_maximum.x - 5} Y{printer.toolhead.axis_maximum.y - 5} F9000

# Reusable safe park helper (back-right)
[gcode_macro _SAFE_PARK]
description: Lift Z and park back-right safely (fits 120x135 bed)
variable_park_z: 10
gcode:
  {% set parkz = params.Z|default(printer["gcode_macro _SAFE_PARK"].park_z)|int %}
  {% set xmax = printer.configfile.config.stepper_x.position_max|default(120)|int %}
  {% set ymax = printer.configfile.config.stepper_y.position_max|default(135)|int %}
  {% set lift = parkz if parkz > 2 else 2 %}
  SAVE_GCODE_STATE NAME=__park
  G91
  G1 Z{lift} F600
  G90
  G1 X{ x_max|default(xmax) - 5 } Y{ y_max|default(ymax) - 5 } F6000
  RESTORE_GCODE_STATE NAME=__park

# Full-clear safe park (top-right + bed forward)
[gcode_macro _PARK_TR_SAFE]
description: Clamp-safe park: Z to (Zmax-0.5), X/Y to (max - margins), bed forward
variable_x_margin: 2.0
variable_y_margin: 2.0
variable_z_margin: 0.5
gcode:
  {% set x_max = (printer.configfile.config.stepper_x.position_max|default(120))|float %}
  {% set y_max = (printer.configfile.config.stepper_y.position_max|default(135))|float %}
  {% set z_max = (printer.configfile.config.stepper_z.position_max|default(100))|float %}
  {% set xm = (params.X_MARGIN|default(printer["gcode_macro _PARK_TR_SAFE"].x_margin))|float %}
  {% set ym = (params.Y_MARGIN|default(printer["gcode_macro _PARK_TR_SAFE"].y_margin))|float %}
  {% set zm = (params.Z_MARGIN|default(printer["gcode_macro _PARK_TR_SAFE"].z_margin))|float %}
  {% set z_now = printer.toolhead.position.z|float %}
  {% set z_target = (z_max - zm) if (z_max - zm) > z_now else (z_now) %}
  G90
  G1 Z{ z_target|round(3) } F18000
  G1 X{ (x_max - xm)|round(3) } F15000
  G1 Y{ (y_max - ym)|round(3) } F15000

# ─────────────────────────────────────────────────────────────────────────────
# START_PRINT — cold/idle probe (no ooze), then heat to temp, then purge
# Notes:
# - No E moves occur before M109 finishes, so no "Extrude below minimum temp".
# - If you want to probe truly cold, leave idle_temp at 0.
# - If you want a little warmth to speed up heating later, set idle_temp ~150.
# ─────────────────────────────────────────────────────────────────────────────
[gcode_macro START_PRINT]
description: Home → (optional cold/idle) adaptive mesh → Smart Park → heat to temp → optional Line Purge (no E moves before M109)
# Toggles you can change from the console/UI:
variable_do_mesh: 1            # 1=run KAMP adaptive mesh via BED_MESH_CALIBRATE
variable_do_purge: 1           # 1=run LINE_PURGE after heating
variable_cold_probe: 1         # 1=keep nozzle cold/idle during mesh to avoid oozing
variable_idle_temp: 150        # temp used during mesh if cold_probe==1; 0 = stay cold

gcode:
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|int %}
  {% set do_mesh       = printer["gcode_macro START_PRINT"].do_mesh|int %}
  {% set do_purge      = printer["gcode_macro START_PRINT"].do_purge|int %}
  {% set cold_probe    = printer["gcode_macro START_PRINT"].cold_probe|int %}
  {% set idle_temp     = printer["gcode_macro START_PRINT"].idle_temp|int %}

  ; --- Sane modal states ---
  G21                      ; mm
  G90                      ; absolute pos
  M82                      ; absolute extrusion
  M107                     ; part fan off

  ; --- Pre-mesh temperature handling (NO E moves here) ---
  {% if cold_probe == 1 %}
    {% if idle_temp > 0 %}
      M104 S{idle_temp}    ; low idle temp to reduce ooze while probing
    {% else %}
      M104 S0              ; stay cold during mesh
    {% endif %}
  {% endif %}

  ; --- Home (BLTouch safe_z_home in your config) ---
  G28

  ; --- Adaptive mesh while nozzle is cold/idle (no oozing) ---
  {% if do_mesh == 1 %}
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE
  {% endif %}

  ; --- Smart Park keeps hotend away from bed while we finish heating ---
  SMART_PARK

  ; --- Now heat to full temp and WAIT (only after this can we move E) ---
  M104 S{EXTRUDER_TEMP}
  M109 S{EXTRUDER_TEMP}

  ; --- Optional KAMP purge (E moves now allowed because we're hot) ---
  {% if do_purge == 1 %}
    LINE_PURGE
    ; Tiny tidy-up to avoid purge tail catching (all at temp):
    {% set ph = (printer["gcode_macro _KAMP_Settings"].purge_height|default(0.30))|float %}
    G92 E0
    G1 E-0.6 F1800          ; small retract to snip the string
    G1 Z{ (ph + 1.0) } F1200
    G1 X20 Y20 F6000        ; move away from the purge start
    G1 E0.6 F150            ; push a touch back so extruder is primed
    G92 E0
  {% endif %}

  M117 Printing...

# END_PRINT: retract, cool, safe park (top-right + bed forward)
[gcode_macro END_PRINT]
description: Cooldown and park (top-right + bed forward)
gcode:
  M107
  M104 S0
  G91
  G1 E-1 F1800
  G90
  _PARK_TR_SAFE
  M84

# Pause/Resume with safe park and optional keep-hot
[gcode_macro PAUSE]
description: Pause with park and fan/heater handling
rename_existing: BASE_PAUSE
gcode:
  {% set keep_hot = params.KEEP_HOT|default(1)|int %}
  BASE_PAUSE
  _SAFE_PARK Z=10
  M106 S0
  {% if not keep_hot %} M104 S0 {% endif %}

[gcode_macro RESUME]
description: Resume and restore state
rename_existing: BASE_RESUME
gcode:
  BASE_RESUME

# ─────────────────────────────────────────────────────────────────────────────
# CANCEL_PRINT — safe version that works even when printing from virtual SD
# Notes:
# - Removed SDCARD_RESET_FILE (that’s what caused your error).
# - Only performs a retract if the nozzle is hot enough to legally extrude.
# ─────────────────────────────────────────────────────────────────────────────
[gcode_macro CANCEL_PRINT]
description: Cancel with queue flush, optional retract (if hot), cool, park, then base cancel
rename_existing: BASE_CANCEL_PRINT
gcode:
  M400                         ; wait for moves to finish
  CLEAR_PAUSE
  SAVE_GCODE_STATE NAME=__canc
  M83                          ; relative extrusion

  ; Only retract if we’re above min_extrude_temp to avoid "Extrude below minimum temp"
  {% set min_ext = printer.configfile.config.extruder.min_extrude_temp|default(170)|int %}
  {% set hot_enough = printer.extruder.temperature|float >= (min_ext|float) %}
  {% if hot_enough %}
    G1 E-2 F1800
  {% endif %}

  RESTORE_GCODE_STATE NAME=__canc
  M106 S0                      ; fan off
  M104 S0                      ; nozzle off
  _PARK_TR_SAFE                ; lift & park out of the way

  ; Do NOT call SDCARD_RESET_FILE here; it errors when run from virtual SD prints.
  ; Mainsail/Fluidd UI will clear the file automatically on cancel.

  BASE_CANCEL_PRINT

# ─────────────────────────────────────────────────────────────
# KlipperScreen Load/Unload tuned for ~440 mm Bowden
# Safe defaults so the motor doesn't skip: SPEED defaults to 5 mm/s.
# Requires nozzle already hot (per KS docs). Heat first if needed.
# ─────────────────────────────────────────────────────────────

[gcode_macro LOAD_FILAMENT]
description: KS button — slow, staged load then purge
# Distance from extruder to nozzle + margin
variable_load_distance: 480    # mm
# Purge once at the melt zone
variable_purge_distance: 25    # mm
gcode:
  {% set spd = (params.SPEED|default(5)|float) %}                 # mm/s from UI
  {% set spd = 1.0 if spd < 1.0 else (10.0 if spd > 10.0 else spd) %}
  {% set F_slow = (spd * 60)|int %}                               # mm/min
  {% set near = (load_distance - 20)|int %}                       # fast-ish bulk
  {% if near < 0 %}{% set near = 0 %}{% endif %}
  SAVE_GCODE_STATE NAME=_load
  G91
  G92 E0
  ; Bulk feed close to hotend at gentle speed
  G1 E{near} F{F_slow}
  ; Ease into melt zone slower to avoid grinding when it meets resistance
  G1 E20 F{ (F_slow // 2) if F_slow > 120 else F_slow }
  ; Purge to establish a solid flow
  G1 E{purge_distance} F{F_slow}
  ; Tiny anti-ooze
  G1 E-1 F{F_slow}
  G90
  RESTORE_GCODE_STATE NAME=_load

[gcode_macro UNLOAD_FILAMENT]
description: KS button — small pre-purge then slow full retract
# How far to fully clear the Bowden + gears
variable_unload_distance: 480   # mm
# Small push to pack the melt before retract (helps form a neat tip)
variable_pre_purge: 5           # mm
gcode:
  {% set spd = (params.SPEED|default(5)|float) %}                 # mm/s from UI
  {% set spd = 1.0 if spd < 1.0 else (10.0 if spd > 10.0 else spd) %}
  {% set F_slow = (spd * 60)|int %}                               # mm/min
  SAVE_GCODE_STATE NAME=_unload
  G91
  G92 E0
  ; Tiny purge to pack the melt
  G1 E{pre_purge} F{F_slow}
  ; Full slow retract through Bowden so the motor doesn't skip
  G1 E-{unload_distance} F{F_slow}
  G90
  RESTORE_GCODE_STATE NAME=_unload

