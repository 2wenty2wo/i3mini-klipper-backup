# ─────────────────────────────────────────────────────────────────────────────
# FILAMENT MANAGEMENT — load/unload for ~440 mm Bowden (Wanhao i3 Mini)
# Segments any long extrude-only move so we never exceed Klipper's 50 mm limit.
# ─────────────────────────────────────────────────────────────────────────────

# Central defaults so helpers/AI have one place to tweak
[gcode_macro _FILAMENT_DEFAULTS]
description: Defaults for filament load/unload on Wanhao i3 Mini (Bowden ~440 mm)
variable_bowden_len: 440         # mm from extruder gears to melt zone
variable_extra_clear: 40         # mm extra beyond Bowden to clear gears
variable_slow_tip_mm: 6          # mm slow pull to neck the tip (clean exit)
variable_push_prime_mm: 10       # mm tiny push before tip-shape
variable_purge_default: 20       # mm purge after load
variable_temp_default: 205       # °C default temp (PLA). Override via TEMP=...
gcode:

# INTERNAL HELPER — segment extrude-only moves (<= 50 mm per G1)
[gcode_macro _E_SEG]
description: Helper that segments long extrude-only moves (avoids 50 mm guard)
# Usage: _E_SEG E=<±distance_mm> F=<feedrate>
gcode:
  {% set dist = params.E|float %}
  {% set feed = params.F|int %}
  {% set step = 50.0 if dist >= 0 else -50.0 %}
  {% set chunks = (abs(dist) / 50.0)|int %}
  {% set remainder = dist - (step * chunks) %}
  G91
  {% for i in range(chunks) %}
    G1 E{step} F{feed}
  {% endfor %}
  {% if abs(remainder) > 0.0001 %}
    G1 E{remainder|round(3)} F{feed}
  {% endif %}
  G90

# UNLOAD — heat → shape tip → clear heatbreak → full Bowden retract + extra
[gcode_macro UNLOAD_FILAMENT]
description: Heat and fully retract filament out of the extruder (Bowden)
gcode:
  {% set T = params.TEMP|default(printer["gcode_macro _FILAMENT_DEFAULTS"].temp_default)|int %}
  {% set L = printer["gcode_macro _FILAMENT_DEFAULTS"].bowden_len|float %}
  {% set EXTRA = printer["gcode_macro _FILAMENT_DEFAULTS"].extra_clear|float %}
  {% set TIP = printer["gcode_macro _FILAMENT_DEFAULTS"].slow_tip_mm|float %}
  {% set PUSH = printer["gcode_macro _FILAMENT_DEFAULTS"].push_prime_mm|float %}
  {% set total = (L + EXTRA)|float %}

  M117 Unloading filament…
  M104 S{T}
  M109 S{T}                 ; wait for temp (avoid "Extrude below min temp")

  ; Tip-shaping: makes a clean “arrowhead” so it won’t snag on reload
  G91
  G1 E{PUSH} F300           ; pack melt
  G4 P1200                  ; ~1.2 s soak
  G1 E-{TIP} F240           ; slow lift to neck the tip
  G90

  ; Clear heatbreak gently, then long segmented retract through Bowden
  _E_SEG E=-30 F1800
  _E_SEG E=-{total|round(3)} F3000

  M117 Filament unloaded — remove spool

# LOAD — heat → drive through Bowden (segmented) → slow into hotend → purge
[gcode_macro LOAD_FILAMENT]
description: Heat and load filament to nozzle, purge, tiny anti-ooze
gcode:
  {% set T = params.TEMP|default(printer["gcode_macro _FILAMENT_DEFAULTS"].temp_default)|int %}
  {% set L = printer["gcode_macro _FILAMENT_DEFAULTS"].bowden_len|float %}
  {% set PURGE = params.PURGE|default(printer["gcode_macro _FILAMENT_DEFAULTS"].purge_default)|float %}

  M117 Loading filament…
  M104 S{T}
  M109 S{T}

  ; Drive most of the way fast (segmented <=50 mm moves)
  _E_SEG E={L|round(3)} F3000

  ; Ease into melt zone, then purge for solid flow
  _E_SEG E=15 F300
  _E_SEG E={PURGE|round(3)} F300

  ; Tiny anti-ooze
  _E_SEG E=-1 F1800

  M117 Filament loaded — ready to print

# ── Compatibility aliases for some KlipperScreen themes ──────────────────────
[gcode_macro FILAMENT_UNLOAD]
description: Alias for UNLOAD_FILAMENT
gcode:
  UNLOAD_FILAMENT {rawparams}

[gcode_macro FILAMENT_LOAD]
description: Alias for LOAD_FILAMENT
gcode:
  LOAD_FILAMENT {rawparams}