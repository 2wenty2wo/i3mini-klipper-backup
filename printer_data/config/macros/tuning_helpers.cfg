# ─────────────────────────────────────────────────────────────────────────────
# TUNING HELPERS: convenience macros for ADXL sanity + shaper calibration
# ─────────────────────────────────────────────────────────────────────────────

[gcode_macro ADXL_SANITY]
description: Check accelerometer is responding and noise is reasonable
gcode:
  RESPOND PREFIX=ADXL MSG="Querying accelerometer…"
  ACCELEROMETER_QUERY
  MEASURE_AXES_NOISE

[gcode_macro RESO_TUNE]
description: Home, warm nozzle, run SHAPER_CALIBRATE on X/Y, then prompt to SAVE_CONFIG
variable_temp: 200
gcode:
  {% set t = params.TEMP|default(printer["gcode_macro RESO_TUNE"].temp)|int %}
  M117 Resonance tune starting…
  {% if printer.toolhead.homed_axes != "xyz" %} G28 {% endif %}
  M104 S{t}
  M109 S{t}
  G90
  {% set x = printer.toolhead.axis_maximum.x / 2 %}
  {% set y = printer.toolhead.axis_maximum.y / 2 %}
  G1 X{ x|round(1) } Y{ y|round(1) } Z20 F6000
  MEASURE_AXES_NOISE
  SHAPER_CALIBRATE
  M117 Review console output; run SAVE_CONFIG if happy

# ─────────────────────────────────────────────────────────────────────────────
# PA_TUNE: prints a tuning tower that sweeps pressure advance
# Usage:  PA_TUNE TEMP=200 START=0.00 FACTOR=0.005 BAND=5
# Then inspect the tower and set extruder.pressure_advance to the best layer.
# ─────────────────────────────────────────────────────────────────────────────
[gcode_macro PA_TUNE]
description: Sweep pressure advance using a tuning tower
variable_temp: 200
variable_start: 0.00
variable_factor: 0.005
variable_band: 5
gcode:
  {% set t = params.TEMP|default(printer["gcode_macro PA_TUNE"].temp)|float %}
  {% set s = params.START|default(printer["gcode_macro PA_TUNE"].start)|float %}
  {% set f = params.FACTOR|default(printer["gcode_macro PA_TUNE"].factor)|float %}
  {% set b = params.BAND|default(printer["gcode_macro PA_TUNE"].band)|float %}
  M117 PA tune…
  {% if printer.toolhead.homed_axes != "xyz" %} G28 {% endif %}
  M104 S{t}
  M109 S{t}
  # Center the head and draw the standard Klipper tuning tower
  TUNING_TOWER COMMAND=SET_PRESSURE_ADVANCE PARAMETER=ADVANCE START={s} FACTOR={f} BAND={b}
  # The object you start now (from your slicer) will vary PA by layer automatically.